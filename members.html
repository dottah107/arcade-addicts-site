<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
  const supabaseUrl = 'https://xvhkwyhncuivsfwfmvbg.supabase.co'
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2aGt3eWhuY3VpdnNmd2ZtdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzQxNjgsImV4cCI6MjA3NDQxMDE2OH0.oeCz6LHCCzLvHqO7q9cNiiiotrUm8kzmzdJjfzBIA-8'
  const supabase = createClient(supabaseUrl, supabaseKey)

  const { data: { session } } = await supabase.auth.getSession()
  if (!session) window.location.href = '/login.html'
  const user = session.user

  const avatarEl = document.getElementById('avatar-preview')
  const displayNameHero = document.getElementById('display-name-hero')
  const heroSection = document.getElementById('hero-section')

  async function loadProfile() {
    const { data } = await supabase.from('profiles').select('*').eq('id', user.id).single()
    if (data) {
      displayNameHero.textContent = data.username || 'Gamer'
      avatarEl.src = data.avatar_url || avatarEl.src
      if (data.background_url) {
        const isVideo = data.background_url.match(/\.(mp4|webm|ogg)$/i)
        if (isVideo) {
          const video = document.createElement('video')
          video.src = data.background_url
          video.autoplay = true
          video.loop = true
          video.muted = true
          heroSection.appendChild(video)
        } else {
          heroSection.style.backgroundImage = `url(${data.background_url})`
        }
      }
    }
  }
  loadProfile()

  async function loadActivity() {
    const feed = document.getElementById('activity-feed')
    feed.innerHTML = ''

    // Get all friend user IDs (yourself included)
    let outFriends = []
    let inFriends = []
    try {
      const outRes = await supabase.from('friend_links').select('friend_id').eq('user_id', user.id)
      if (outRes.data) outFriends = outRes.data
      const inRes = await supabase.from('friend_links').select('user_id').eq('friend_id', user.id)
      if (inRes.data) inFriends = inRes.data
    } catch {}

    const userIds = new Set()
    outFriends.forEach(f => userIds.add(f.friend_id))
    inFriends.forEach(f => userIds.add(f.user_id))
    userIds.add(user.id) // always include self

    const idsArray = Array.from(userIds)
    if (!idsArray.length) {
      feed.innerHTML = '<p>No activity yet.</p>'
      return
    }

    // Fetch all activities
    let activities = []
    try {
      const actRes = await supabase
        .from('activity_feed')
        .select('*')
        .in('user_id', idsArray)
        .order('timestamp', { ascending: false })
        .limit(25)
      if (actRes.data) activities = actRes.data
    } catch {}
    if (!activities.length) {
      feed.innerHTML = '<p>No activity yet.</p>'
      return
    }

    // Fetch all usernames
    let usernameMap = {}
    try {
      const uniqueUserIds = [...new Set(activities.map(a => a.user_id))]
      const profRes = await supabase
        .from('profiles')
        .select('id,username')
        .in('id', uniqueUserIds)
      if (profRes.data) {
        profRes.data.forEach(p => { usernameMap[p.id] = p.username })
      }
    } catch {}

    // Render activities
    for (let act of activities) {
      let mediaBlock = ''
      if (act.url) {
        if ((/\.(mp4|webm|ogg)$/i).test(act.url)) {
          mediaBlock = `<video src="${act.url}" muted autoplay loop></video>`
        } else {
          mediaBlock = `<img src="${act.url}" alt="Activity media">`
        }
      }
      const linkUrl = act.url ? act.url : '#'
      const username = usernameMap[act.user_id] || act.user_id
      const item = document.createElement('a')
      item.className = 'activity-item'
      item.href = linkUrl
      item.target = '_blank'
      item.innerHTML = `
        ${mediaBlock}
        <div class="info">
          <p class="author">${username}</p>
          <p class="time">${new Date(act.timestamp || act.created_at).toLocaleString()}</p>
        </div>
      `
      feed.appendChild(item)
    }
  }
  loadActivity()

  document.getElementById('logout-link').onclick = async () => {
    await supabase.auth.signOut()
    window.location.href = '/login.html'
  }
</script>

<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Member • Arcade Addicts</title>
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#000;--panel:#0b0b0b;--surface:#0f0f0f;--muted:#161616;--text:#fff;--accent:#00FFFF;--radius:14px;--max:1000px}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#000;color:#fff}
.wrap{max-width:var(--max);margin:24px auto;padding:0 16px}
h1{margin:0 0 14px;color:var(--accent)} .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
.btn{padding:10px 14px;border-radius:12px;border:none;font-weight:800;cursor:pointer}
.btn.primary{background:var(--accent);color:#000}.btn.ghost{background:transparent;border:2px solid var(--accent);color:var(--accent)}
.panel{background:var(--surface);border:1px solid var(--muted);border-radius:var(--radius);padding:16px;margin:14px 0}
label{display:block;margin:8px 0 6px;font-weight:600}
input[type=file],textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #222;background:#0b0b0b;color:#fff}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
@media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}@media (max-width:600px){.grid{grid-template-columns:1fr}}
.card{background:#0b0b0b;border:1px solid #222;border-radius:12px;overflow:hidden}
.card .body{padding:12px}
.card img,.card video{width:100%;display:block}
small.time{color:#a8e;opacity:.85}
#msg{min-height:1.3em;color:#f99;font-weight:600;margin:6px 0}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head><body>
<div class="wrap">
  <div class="row">
    <h1>Member Dashboard</h1>
    <div>
      <span id="who" style="margin-right:10px;opacity:.8"></span>
      <button id="signout" class="btn ghost">Sign out</button>
    </div>
  </div>

  <div id="msg"></div>

  <div class="panel">
    <h2 style="margin:0 0 10px">Post a highlight</h2>
    <label for="file">Image or video (optional)</label>
    <input id="file" type="file" accept="image/*,video/*">
    <label for="content">What's on your mind? (optional if uploading media)</label>
    <textarea id="content" rows="3" placeholder="GGs! Pulled off a nasty combo…"></textarea>
    <button id="post" class="btn primary">Post</button>
  </div>

  <div class="panel">
    <h2 style="margin:0 0 10px">Your recent posts</h2>
    <div id="feed" class="grid"></div>
  </div>
</div>

<script>
const sb = supabase.createClient("https://xvhkwyhncuivsfwfmvbg.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2aGt3eWhuY3VpdnNmd2ZtdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MzQxNjgsImV4cCI6MjA3NDQxMDE2OH0.oeCz6LHCCzLvHqO7q9cNiiiotrUm8kzmzdJjfzBIA-8");
const $ = (id)=>document.getElementById(id);
const show = (m)=>{ const el=$("msg"); if(el) el.textContent=m||""; };

function fmtTime(ts){ try{ return new Date(ts).toLocaleString(); }catch(_){ return ts; } }

async function guard(){
  const { data:{ session } } = await sb.auth.getSession();
  if(!session){ location.href="/login/?next=/member/"; return null; }
  $("who").textContent = session.user.email;
  return session.user;
}

async function loadMine(user){
  const { data, error } = await sb.from("posts").select("*").eq("user_id", user.id).order("created_at", { ascending:false }).limit(30);
  if(error){ show(error.message); return; }
  const feed = $("feed"); feed.innerHTML="";
  (data||[]).forEach(p=>{
    const card = document.createElement("div"); card.className="card";
    if(p.media_url){
      if((p.media_type||"").startsWith("video")){
        const v=document.createElement("video"); v.controls=true; v.src=p.media_url; card.appendChild(v);
      }else{
        const img=document.createElement("img"); img.src=p.media_url; img.alt=""; card.appendChild(img);
      }
    }
    const body=document.createElement("div"); body.className="body";
    body.innerHTML = (p.content?("<p>"+String(p.content).replace(/[<>&]/g,s=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[s]))+"</p>"):"")
                  + `<small class="time">${fmtTime(p.created_at)}</small>`;
    card.appendChild(body);
    feed.appendChild(card);
  });
}

async function postIt(user){
  const file = $("file").files[0] || null;
  const text = $("content").value.trim();
  if(!file && !text){ show("Add text or choose a file."); return; }
  show("");

  let media_url=null, media_type=null;
  if(file){
    const ext = (file.name.split(".").pop()||"").toLowerCase();
    const path = `${user.id}/${Date.now()}-${Math.random().toString(36).slice(2)}.${ext}`;
    const up = await sb.storage.from("highlights").upload(path, file, { cacheControl: "3600", upsert: false, contentType: file.type||undefined });
    if(up.error){ show(up.error.message); return; }
    const pub = sb.storage.from("highlights").getPublicUrl(path);
    media_url = pub.data.publicUrl;
    media_type = (file.type||"").startsWith("video") ? "video" : "image";
  }

  const ins = await sb.from("posts").insert({ user_id:user.id, content:text||null, media_url, media_type });
  if(ins.error){ show(ins.error.message); return; }

  $("file").value=""; $("content").value="";
  await loadMine(user);
}

(async()=>{
  const user = await guard(); if(!user) return;

  $("post").onclick = ()=>postIt(user);
  $("signout").onclick = async ()=>{ await sb.auth.signOut(); location.href="/login/"; };

  await loadMine(user);
})();
</script>
</body></html>
